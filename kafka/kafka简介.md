### 消息系统

在实际的业务需求中，我们需要处理各种各样的消息，比如Page View,日志，请求等，那么一个好的消息系统应该拥有哪些功能呢？

- 拥有**消息发布和订阅**的功能，类似于消息队列或者企业消息传送系统；
- 能**存储消息流**，并具备容错性；
- 能够**实时的处理消息**；



### Kafka的基本概念

- Kafka是运行在一个集群上，所以它可以拥有一个或多个服务节点；
- Kafka集群将消息存储在特定的文件中，对外表现为Topics；
- 每条消息记录都包含一个key,消息内容以及时间戳；

Kafka为了拥有更强大的功能，提供了四大核心接口：

- Producer API允许了应用可以向Kafka中的topics发布消息；
- Consumer API允许了应用可以订阅Kafka中的topics,并消费消息；
- Streams API允许应用可以作为消息流的处理者，比如可以从topicA中消费消息，处理的结果发布到topicB中；
- Connector API提供Kafka与现有的应用或系统适配功能，比如与数据库连接器可以捕获表结构的变化；



#### Topics

Topic就像一个消息队列，生产者可以向其写入消息，消费者可以从中读取消息，一个Topic支持**多个**生产者或消费者同时订阅它，所以其扩展性很好。Topic又可以由一个或多个partition（分区）组成，比如下图：

![log-anatomy](../images/log-anatomy.png)

其中每个partition中的消息是有序的，但相互之间不能保证有序，若Topic有多个partition，生产者的消息可以指定或者由系统根据算法分配到指定分区，**若你需要所有消息都是有序的，那么你最好只用一个分区**。另外partition支持消息位移读取，消息位移有消费者自身管理，比如下图：

<img src="../images/log-consumer.png" alt="log-consumer" style="zoom: 25%;" />

由上图可以看出，**不同消费者对同一分区的消息读取互不干扰**，消费者可以通过设置消息位移（**offset**）来控制自己想要获取的数据，比如可以从头读取，最新数据读取，重读读取等功能。



### 分布式

Kafka是一个分布式的消息系统，所以当我们配置了多个Kafka Server节点后，它就拥有分布式的能力，比如容错等，partition会被分布在各个Server节点上，同时它们中间又有一个leader，它会**处理所有的读写请求**，其他followers会复制leader上的数据信息，一旦当leader因为某些故障而无法提供服务后，就会有一个follower被推举出来成为新的leader来处理这些请求

>  follower只是负责备份，如果follower也能消费，性能固然有所提升，但会涉及到同步开销等一致性问题，这其实是对性能和一致性的取舍



#### Producers

Producers作为消息的生产者，可以自己指定将消息发布到订阅Topic中的**指定分区**，策略可以自己指定，比如语义或者结构类似的消息发布在同一分区，当然也可以由系统循环发布在每一个分区上。



#### Consumers

Consumers是一群消费者的集合，可以称之为消费者组，是一种更高层次的的抽象，向Topic订阅消费消息的**单位**是Consumers，当然它其中也可以只有一个消费者（consumer）。下面是关于consumer的两条原则：

- 假如所有消费者都在同一个消费者组中，那么它们将**协同消费**订阅Topic的部分消息（根据分区与消费者的数量分配），保存负载平衡；
- 假如所有消费者都在不同的消费者组中，并且订阅了同个Topic，那么它们将可以消费Topic的所有消息；

![consumer-groups](../images/consumer-groups.png)

上图中有两个Server节点，有一个Topic被分为四个分区（P0-P4)分别被分配在两个节点上，另外还有两个消费者组（GA，GB），其中GA有两个消费者实例，GB有四个消费者实例。

从图中我们可以看出，首先订阅Topic的单位是消费者组，另外我们发现Topic中的消息根据一定规则将消息推送给具体消费者，主要原则如下：

- 若消费者数小于partition数，且消费者数为一个，那么它就消费所有消息；
- 若消费者数小于partition数，假设消费者数为N，partition数为M，那么每个消费者能消费的分区数为M/N或M/N+1；
- 若消费者数等于partition数，那么每个消费者都会均等分配到一个分区的消息；
- 若消费者数大于partition数，则将会出现部分消费者得不到消息分区，出现空闲的情况；

总的来说，Kafka会根据消费者组的情况均衡分配消息，比如有消息着实例宕机，亦或者有新的消费者加入等情况。



### 可靠性

kafka作为一个高水准的系统，提供了以下的保证：

- 消息的添加是有序的，生产者越早向订阅的Topic发送的消息，会更早的被添加到Topic中，当然它们可能被分配到不同的分区；
- 消费者在消费Topic分区中的消息时是有序的；
- 对于有N个复制节点的Topic，系统可以最多容忍N-1个节点发生故障，而不丢失任何提交给该Topic的消息丢失；
